---
title: "STDA-project"
output:
  pdf_document: default
  html_document: default
---


```{r}
require(zoo)
require(xts)
data <- read.csv("sims2018milan.csv",sep = ";")
data <- rbind(data, read.csv("foreignsim_2019-11-07.csv",sep = ";"))

data$prefix <- NULL
data$country <- NULL
data$num <- NULL
data$total.ita.sim <- NULL
```



```{r}
ll <- aggregate.data.frame(data$total.foreign.sim,by=list(data$date),FUN=mean)
names(ll)[2] <- "total.foreign.sim"
names(ll)[1] <- "Date"
data <- ll

dim(data)
data <- data[-c(656,657,658), ]
dim(data)

print("minimum, lower-hinge, median, upper-hinge, maximum)")
fivenum(data$total.foreign.sim)
hist(data$total.foreign.sim)
```


```{r}
data$Date <- as.Date(data$Date, format = "%Y-%m-%d")
#typeof(data$date[1])
data.xts <- xts(data$total.foreign.sim, order.by=data$Date, frequency = 7)
data.ts <- ts(data$total.foreign.sim, frequency = 7)

main <- "foreign sim per day"
ylab<-"Tot of sim in that day"
plot(data.xts,ylab=ylab,main=main)
```


```{r}
tt<-as.numeric(time(data.ts))
fit2<-lm(data.ts~poly(tt,degree=2,raw=TRUE))
fit4<-lm(data.ts~poly(tt,degree=8,raw=TRUE))

main <- "foreign sim per day"
plot(data.ts,ylab=ylab,main=main)
lines(tt,predict(fit2),col='red',lwd=2)
lines(tt,predict(fit4),col='blue',lwd=2)
legend("bottomright",legend = c("2nd order","4th order"),lwd=2,lty=1,col=c("red","blue"))
```





# detrend usong LM

```{r}
detrended.lin <- data.ts - ma(data.ts, order = 7, centre = T)
#detrended.lin <- data.ts - predict(fit4)
plot(detrended.lin)
```


# Removing seasonality


```{r}
plot(diff(data.ts))
differenced <- diff(data.ts)
#differenced <- diff(differenced)
decomposed <- decompose(differenced,type = "multiplicative")
plot(decomposed)

checkresiduals(decomposed$random)
Box.test(decomposed$random, lag=5, fitdf=0)
Box.test(decomposed$random, lag=5, fitdf=0, type="Lj")
```


Every 7 lags the peak recurs


```{r}
acf(na.omit(decomposed$random), main = "Standardized Residuals", 36)
```


```{r}
pacf(na.omit(decomposed$random), main = "Standardized Residuals", 36)
```


```{r}
require(fpp)
# data.ts.box <- BoxCox(data.ts,lambda=0.4)
fit <- Arima(differenced, order=c(3,1,3))
summary(fit)
```

```{r}
checkresiduals(fit)
```

```{r}
autoplot(forecast(fit))

```


# Auto Arima


```{r}
require(fpp)
auto.arima(differenced,stepwise=TRUE,trace=TRUE,ic = "bic")
```



```{r}
frequency(data.ts)
```


prima diff, poi prima diff seasonal, check acf pacf, check no trend(trend se con decadono a 0 velocemente)
identificare i picchi
identificare l estate
doppia seasonality una settimanale e una annuale
ARCH
GARCH
VAR<----
stabilizzare con trasformazioni
