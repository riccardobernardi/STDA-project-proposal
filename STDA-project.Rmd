---
title: "Spatio-Temporal Data Analysis Project"
date: "`r Sys.Date()`"
output:
   pdf_document:
     fig_caption: true
     number_sections: true
fontsize: 12pt
---


![](./foscari.jpg)

# Patterns in foreign sims connected to OpenWiFi-Milan  {-}

Author: Bernardi Riccardo - 864018

\newpage
\tableofcontents
\newpage
<!-- \listoffigures -->
<!-- \newpage -->
<!-- \listoftables -->
<!-- \newpage -->

```{r include = FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```


# Introduction & Motivation


# Loading the Data


```{r}
setwd("~/Documents/GitHub/STDA-project-proposal")
set.seed(25061997)

require(zoo)
require(xts)
data <- read.csv("sims2018milan.csv",sep = ";")
data <- rbind(data, read.csv("foreignsim_2019-11-07.csv",sep = ";"))

data$prefix <- NULL
data$country <- NULL
data$num <- NULL
data$total.ita.sim <- NULL

ll <- aggregate.data.frame(data$total.foreign.sim,by=list(data$date),FUN=mean)
names(ll)[2] <- "total.foreign.sim"
names(ll)[1] <- "Date"
data <- ll

data <- data[-c(656,657,658), ]
```

# Exploration of the Data

```{r}
print("minimum, lower-hinge, median, upper-hinge, maximum)")
fivenum(data$total.foreign.sim)
```

```{r}
hist(data$total.foreign.sim)
```

We loaded the dataset from the various datasets aggregating into only one dataset with 655 rows representing 2 years of data gathered. Starting from 01.01.2018 to 30.10.2019. Data is here sette

```{r}
data$Date <- as.Date(data$Date, format = "%Y-%m-%d")
#typeof(data$date[1])
data.xts <- xts(data$total.foreign.sim, order.by=data$Date, frequency = 7)
data.ts <- ts(data$total.foreign.sim, frequency = 7)

main <- "foreign sim per day"
ylab<-"Tot of sim in that day"
plot(data.xts,ylab=ylab,main=main)
```

# Trend recognition

```{r}
tt<-as.numeric(time(data.ts))
fit2<-lm(data.ts~poly(tt,degree=2,raw=TRUE))
fit4<-lm(data.ts~poly(tt,degree=8,raw=TRUE))

main <- "foreign sim per day"
plot(data.ts,ylab=ylab,main=main)
lines(tt,predict(fit2),col='red',lwd=2)
lines(tt,predict(fit4),col='blue',lwd=2)
legend("bottomright",legend = c("2nd order","4th order"),lwd=2,lty=1,col=c("red","blue"))
```





## Detrending using LM

```{r}
require(fpp)
detrended.lin <- data.ts - ma(data.ts, order = 7, centre = T)
#detrended.lin <- data.ts - predict(fit4)
plot(detrended.lin)
```

# Removing seasonality

A good idea is to differenciate before decomposing. With the multiplicative model

```{r}
differenced <- diff(data.ts)
plot(differenced)

decomposed <- decompose(differenced,type = "multiplicative")
plot(decomposed)

checkresiduals(decomposed$random)

Box.test(decomposed$random, lag=5, fitdf=0)
Box.test(decomposed$random, lag=5, fitdf=0, type="Lj")
```

With the additive model
This model doesn't work at all

```{r}
differenced <- diff(data.ts)
plot(differenced)

decomposed <- decompose(differenced,type = "additive")
plot(decomposed)

checkresiduals(decomposed$random)

Box.test(decomposed$random, lag=5, fitdf=0)
Box.test(decomposed$random, lag=5, fitdf=0, type="Lj")
```

Without the first differentiation the result will have been much worse:

```{r}
not.differenced <- data.ts
plot(not.differenced)

decomposed <- decompose(not.differenced,type = "multiplicative")
plot(decomposed)

checkresiduals(decomposed$random)

Box.test(decomposed$random, lag=5, fitdf=0)
Box.test(decomposed$random, lag=5, fitdf=0, type="Lj")
```

Every 7 lags the peak recurs

# Check Residuals

```{r}
acf(na.omit(decomposed$random), main = "Standardized Residuals", 36)
```


```{r}
pacf(na.omit(decomposed$random), main = "Standardized Residuals", 36)
```

# Arima

```{r}
require(fpp)
fit <- Arima(differenced, order=c(3,1,3))
summary(fit)
```

```{r}
checkresiduals(fit)
```

```{r}
autoplot(forecast(fit))

```


# Auto Arima


```{r}
require(fpp)
auto.arima(data.ts,stepwise=TRUE,trace=TRUE,ic = "bic")
aa <- Arima(order = c(3,1,1), seasonal = c(2,0,0), y = data.ts)
```

```{r}
plot(forecast(aa,data.ts))
```

The plot is not good but AIC and BIC are very high, we should try with a multi seasonal decomposition

```{r}
frequency(data.ts)
```


# Searching for multi seasonalities

without differentiation residuals looks pretty bad

```{r}
library(lubridate)
library(dplyr)
library(forecast)
library(ggplot2)
library(scales)

data.ts %>% decompose(type="multiplicative") %>% autoplot()
dec <- decompose(data.ts)
acf(na.omit(dec$random), lag.max = 30)
```

trying with differentiation and a multiplicative model:

```{r}
differenced %>% decompose(type="multiplicative") %>% autoplot()
dec <- decompose(differenced,type="multiplicative")
acf(na.omit(dec$random))
```

Looks better than before but we can still see every 5(\*7) a seasonality/trend left. 5\*7 is about a month, probably there is a monthly seasonality

# Transforming into msts


```{r}
require(forecast)
msts_cons <- msts(as.data.frame(diff(data.ts)), seasonal.periods = c(7, 30, 4*30))
msts_cons %>% mstl() %>% autoplot()
decomposed <- mstl(msts_cons)
```

```{r}
checkresiduals(remainder(decomposed))
Box.test(remainder(decomposed), lag=5, fitdf=0)
Box.test(remainder(decomposed), lag=5, fitdf=0, type="Lj")
```


# Conclusions


It was really interesting!


# TODO

prima diff, poi prima diff seasonal, check acf pacf, check no trend(trend se con decadono a 0 velocemente)
identificare i picchi
identificare l estate
doppia seasonality una settimanale e una annuale
ARCH
GARCH
VAR<----
stabilizzare con trasformazioni
