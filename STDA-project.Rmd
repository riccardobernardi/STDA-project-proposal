---
title: "STDA-project"
output:
  pdf_document: default
  html_document: default
---


```{r}
require(zoo)
require(xts)
data <- read.csv("sims2018milan.csv",sep = ";")
data <- rbind(data, read.csv("foreignsim_2019-11-07.csv",sep = ";"))

data$prefix <- NULL
data$country <- NULL
data$num <- NULL
data$total.ita.sim <- NULL
```



```{r}
ll <- aggregate.data.frame(data$total.foreign.sim,by=list(data$date),FUN=mean)
names(ll)[2] <- "total.foreign.sim"
names(ll)[1] <- "Date"
data <- ll

dim(data)
data <- data[-c(656,657,658), ]
dim(data)

print("minimum, lower-hinge, median, upper-hinge, maximum)")
fivenum(data$total.foreign.sim)
hist(data$total.foreign.sim)
```


```{r}
data$Date <- as.Date(data$Date, format = "%Y-%m-%d")
#typeof(data$date[1])
data.xts <- xts(data$total.foreign.sim, order.by=data$Date, frequency = 7)
data.ts <- ts(data$total.foreign.sim, frequency = 7)

main <- "foreign sim per day"
ylab<-"Tot of sim in that day"
plot(data.xts,ylab=ylab,main=main)
```


```{r}
tt<-as.numeric(time(data.ts))
fit2<-lm(data.ts~poly(tt,degree=2,raw=TRUE))
fit4<-lm(data.ts~poly(tt,degree=8,raw=TRUE))

main <- "foreign sim per day"
plot(data.ts,ylab=ylab,main=main)
lines(tt,predict(fit2),col='red',lwd=2)
lines(tt,predict(fit4),col='blue',lwd=2)
legend("bottomright",legend = c("2nd order","4th order"),lwd=2,lty=1,col=c("red","blue"))
```





# detrend usong LM

```{r}
require(fpp)
detrended.lin <- data.ts - ma(data.ts, order = 7, centre = T)
#detrended.lin <- data.ts - predict(fit4)
plot(detrended.lin)
```


# Removing seasonality


```{r}
plot(diff(data.ts))
differenced <- diff(data.ts)
#differenced <- diff(differenced)
decomposed <- decompose(differenced,type = "multiplicative")
plot(decomposed)

checkresiduals(decomposed$random)
Box.test(decomposed$random, lag=5, fitdf=0)
Box.test(decomposed$random, lag=5, fitdf=0, type="Lj")
```


Every 7 lags the peak recurs


```{r}
acf(na.omit(decomposed$random), main = "Standardized Residuals", 36)
```


```{r}
pacf(na.omit(decomposed$random), main = "Standardized Residuals", 36)
```


```{r}
require(fpp)
# data.ts.box <- BoxCox(data.ts,lambda=0.4)
fit <- Arima(differenced, order=c(3,1,3))
summary(fit)
```

```{r}
checkresiduals(fit)
```

```{r}
autoplot(forecast(fit))

```


# Auto Arima


```{r}
require(fpp)
auto.arima(data.ts,stepwise=TRUE,trace=TRUE,ic = "bic")
aa <- Arima(order = c(3,1,1), seasonal = c(2,0,0), y = data.ts)
```

```{r}
plot(forecast(aa,data.ts))
```




```{r}
frequency(data.ts)
```


# GARCH Model

```{r}
library(rugarch)

spec <- ugarchspec()
fit <- ugarchfit(spec = spec, data = data.ts)
#forc = ugarchforecast(fit, n.ahead=20)
forc <- ugarchforecast(spec, n.ahead = 1, n.roll = 654, data = data.ts[1:655, ,drop=FALSE], out.sample = 654)
forc
plot(data.ts)
plot(forc,which="all")
```

```{r}
library(rugarch)
library(xts)
fit = ugarchfit(ugarchspec(), data.ts, out.sample = 10)
c(is(sigma((fit))), is(fitted(fit)), is(residuals(fit)))
## [1] 'xts' 'xts' 'xts'
##
plot(xts(fit@model$modeldata$data, fit@model$modeldata$index), auto.grid = FALSE,
    minor.ticks = FALSE, main = 'S&P500 Conditional Mean')
lines(fitted(fit), col = 2)
grid()
```

```{r}
plot(xts(abs(fit@model$modeldata$data), fit@model$modeldata$index), auto.grid = FALSE,
    minor.ticks = FALSE, main = 'S&P500 Conditional Sigma', col = 'grey')
lines(sigma(fit), col = 'steelblue')
grid()
```


# searching for inner seasolanalities

```{r}
library(lubridate)
library(dplyr)
library(forecast)
library(ggplot2)
library(scales)

data.ts %>% decompose() %>% autoplot()
dec <- decompose(data.ts)
acf(na.omit(dec$random))
```


# Should continue the decomposition

```{r}
ts(dec$random,frequency=5) %>% decompose() %>% autoplot()
dec2 <- decompose(ts(dec$random,frequency=5))
acf(na.omit(dec2$random))
```


# Transforming into msts


```{r}
msts_cons <- msts(as.data.frame(data.ts), seasonal.periods = c(7, 30, 3*30, 6*30))
msts_cons %>% mstl() %>% autoplot()
decomposed <- mstl(msts_cons)
attributes(decomposed)
```

```{r}
decomposed["Remainder"]
```


prima diff, poi prima diff seasonal, check acf pacf, check no trend(trend se con decadono a 0 velocemente)
identificare i picchi
identificare l estate
doppia seasonality una settimanale e una annuale
ARCH
GARCH
VAR<----
stabilizzare con trasformazioni
