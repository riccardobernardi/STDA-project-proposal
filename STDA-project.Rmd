---
title: "STDA-project"
output: html_document
---


```{r}
require(zoo)
require(xts)
data <- read.csv("sims2018milan.csv",sep = ";")
data <- rbind(data, read.csv("foreignsim_2019-11-07.csv",sep = ";"))

data$prefix <- NULL
data$country <- NULL
data$num <- NULL
data$total.ita.sim <- NULL
```



```{r}
ll <- aggregate.data.frame(data$total.foreign.sim,by=list(data$date),FUN=mean)
names(ll)[2] <- "total.foreign.sim"
names(ll)[1] <- "Date"
data <- ll

print("minimum, lower-hinge, median, upper-hinge, maximum)")
fivenum(data$total.foreign.sim)
dim(data)
hist(data$total.foreign.sim)
```


```{r}
data$Date <- as.Date(data$Date, format = "%Y-%m-%d")
#typeof(data$date[1])
data.xts <- xts(data$total.foreign.sim, order.by=data$Date, frequency = 365)
data.ts <- ts(data$total.foreign.sim)

main <- "foreign sim per day"
ylab<-"Tot of sim in that day"
plot(data.xts,ylab=ylab,main=main)
```


```{r}
tt<-as.numeric(time(data.ts))
fit2<-lm(data.ts~poly(tt,degree=2,raw=TRUE))
fit4<-lm(data.ts~poly(tt,degree=4,raw=TRUE))
```



```{r}
main <- "foreign sim per day"
plot(data.ts,ylab=ylab,main=main)
lines(tt,predict(fit2),col='red',lwd=2)
lines(tt,predict(fit4),col='blue',lwd=2)
legend("bottomright",legend = c("2nd order","4th order"),lwd=2,lty=1,col=c("red","blue"))
```



```{r}
data.xts.log <- xts(sqrt(data$total.foreign.sim), order.by=data$Date, frequency = 365)

main <- "foreign sim per day"
ylab<-"Tot of sim in that day"
plot(data.xts.log,ylab=ylab,main=main)
```

# Decomposing non seasonal data

```{r}
require(TTR)
data.ts.ma <- SMA(data.ts, n=5)
plot.ts(data.ts.ma)
```


```{r}
# Decomposing seasonal data
#data.ts.dec <- decompose(data.ts)
#plot.ts(data.ts.dec)
#Error in decompose(data.ts) : time series has no or less than 2 periods
# so no seasonality ca be fou d by R
```


```{r}
#install.packages("forecast")
library(forecast)
trend.data = ma(data.ts, order = 12, centre = T)
plot(data.ts)
lines(trend.data, col="red")
```

# Detrending

```{r}
detrend.data = data.ts - trend.data
plot(detrend.data)
```

# Finding seasonality

```{r}
m_data = t(matrix(data = detrend.data, nrow = 4))
seasonal.data = colMeans(m_data, na.rm = T)
plot(as.ts(rep(seasonal.data,16)))
```

# the rest is residuals

```{r}
random.data = data.ts - trend.data - seasonal.data
plot(random.data)
```

```{r}
Box.test(random.data, lag=10, fitdf=0)
```


```{r}
Box.test(random.data, lag=10, fitdf=0, type="Lj")
```

```{r}
checkresiduals(naive(random.data))
```




